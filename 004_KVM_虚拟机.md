# KVM 虚拟机

> By WuDiXianXin

## 安装 KVM

### 一、检查硬件支持

#### 虚拟化支持检测

```bash
LC_ALL=C.UTF-8 lscpu | grep Virtualization
grep -E --color=auto 'vmx|svm|0xc0f' /proc/cpuinfo  # 直接检测CPU虚拟化标志
lsmod | grep kvm                                  # 验证内核模块是否加载
```

#### 若 lsmod 无输出，需手动加载模块

```bash
# 二选一
sudo modprobe kvm_intel  # Intel CPU
sudo modprobe kvm_amd    # AMD CPU
```

### 二、安装必要软件包

#### 安装核心组件

```bash
sudo pacman -S qemu-desktop libvirt virt-manager virt-viewer \
dmidecode ebtables iptables-nft dnsmasq openbsd-netcat ovmf swtpm
```

#### 各包的作用及重要性

1. **核心必需包（不可缺少）**：
   - `qemu-desktop`：KVM 依赖的虚拟化核心引擎，提供虚拟机运行环境。
   - `libvirt`：管理虚拟化平台的 API 和工具，是 `virt-manager` 等工具的基础。
   - `virt-manager`：图形化虚拟机管理工具，日常操作的主要界面。
   - `virt-viewer`：用于连接和显示虚拟机的图形界面（如 VNC 连接）。
   - `dnsmasq`：为虚拟机提供 DNS 和 DHCP 服务（默认虚拟网络依赖）。
   - `ovmf`：提供 UEFI 固件支持，现代虚拟机启动（尤其 Windows 虚拟机）依赖。

2. **网络相关重要包（建议保留）**：
   - `ebtables`：用于虚拟机网络的以太网桥接防火墙规则管理。
   - `iptables-nft`：管理网络防火墙规则，控制虚拟机与外部网络的通信。
   - `openbsd-netcat`：提供网络工具（如端口转发测试、虚拟机网络调试）。

3. **相对不重要的包**：
   - **`dmidecode`**：
     功能是读取硬件的 DMI（桌面管理接口）信息（如主板型号、BIOS 版本等）。
     对 KVM 核心功能（创建、运行、管理虚拟机）**无直接影响**，仅在少数场景下有用（如虚拟机需要模拟特定硬件信息时辅助调试）。
     即使不安装，也不会影响 KVM 的正常使用。
   - `swtpm`：
     这是 TPM（可信平台模块）模拟工具，如果你需要安装 Windows 11，会因为缺少 TPM 2.0 而安装失败。

### 三、配置服务与用户权限

#### 配置 libvirt 规则

```bash
sudo nano /etc/polkit-1/rules.d/50-libvirt.rules
```

```ini
/* 允许 kvm 用户组成员无需认证即可管理 libvirt 守护进程 */
polkit.addRule(function(action, subject) {
  if (action.id == "org.libvirt.unix.manage" &&  
      subject.isInGroup("kvm")) {
    return polkit.Result.YES;
  }
});
```

#### 将用户加入必要用户组

```bash
sudo usermod -aG libvirt,kvm $(whoami)
# 完成后需 重新登录(或重启) 或执行 newgrp libvirt 使配置生效
```

#### 配置 Libvirt 权限（可选）

```bash
sudo nvim /etc/libvirt/libvirtd.conf
```

```ini
unix_sock_group = "libvirt"
unix_sock_rw_perms = "0770"
```

#### 配置开机自启动服务

```bash
# 启动并启用 libvirtd 和 virtlogd 服务，
# 不要开机自启 dnsmasq 服务，
# 因为 libvirt 在创建和开启虚拟机时自动实例化一个 dnsmasq 进程
sudo systemctl enable --now libvirtd virtlogd
```

### 四、创建虚拟机

#### 使用图形化工具（推荐）

```bash
# 启动 virt-manager
virt-manager
```

```
• 点击“新建虚拟机”，选择 ISO 镜像或网络安装源。
• 配置 CPU、内存、磁盘大小等参数。
```

### 五、管理虚拟机

```bash
# 常用命令
virsh list --all      # 查看所有虚拟机
virsh start arch-vm   # 启动虚拟机
virsh shutdown arch-vm # 正常关机
virsh destroy arch-vm # 强制关闭
```

### 六、常见问题

#### 网络桥接配置失败

```
确保 `bridge-utils` 已安装，并配置 `/etc/netctl` 或 `systemd-networkd` 的网络桥接。
```

#### 权限不足错误

```
检查用户是否在 `libvirt` 和 `kvm` 组，并重启服务。
```
