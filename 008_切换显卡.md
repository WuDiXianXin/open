# 混合模式

## 一、核心思路

Wayland 环境下的显卡自动切换依赖 **混合模式（Hybrid Mode）**，
即系统默认使用 Intel 核显（低功耗），仅在运行高性能需求应用（如游戏、视频渲染）时调用 NVIDIA 独显。
关键是要移除强制指定 NVIDIA 独显的配置，让系统自动识别硬件并调度。

## 二、前置准备

1. **确认驱动与内核支持**  
   - 确保已安装 NVIDIA 闭源驱动（dkms 版，如 `nvidia-dkms`）和 Intel 核显驱动（通常默认安装，如 `mesa`）。  
   - 内核参数需启用 NVIDIA DRM 模式（否则 Wayland 无法正常识别显卡），在 `/etc/default/grub` 中添加：  

     ```bash
     GRUB_CMDLINE_LINUX_DEFAULT="... nvidia-drm.modeset=1"
     ```  

     更新 grub：`sudo update-grub`（或 `sudo grub-mkconfig -o /boot/grub/grub.cfg`，依发行版而定）。

2. **安装显卡切换工具**  
   推荐使用 `envycontrol` 管理混合模式（支持 NVIDIA 闭源驱动的 Optimus 切换）：  

   ```bash
   # Arch 系安装（其他发行版可参考官网）
   paru -S envycontrol
   ```  

   设置为混合模式：  

   ```bash
   sudo envycontrol -s hybrid  # 切换到混合模式（核显默认，独显按需调用）
   ```  

   重启系统使设置生效。

## 三、修改 Hyprland 配置（`hypr.conf`）

当前配置中存在强制启用 NVIDIA 独显的参数，需删除或注释，让系统自动选择显卡。具体调整如下：

### 1. 移除强制指定 NVIDIA 设备的配置

```diff
- # Wayland协议扩展，强制指定渲染设备为NVIDIA独显
- env = WLR_DRM_NO_ATOMIC=1 # 若遇到显示异常时启用
- env = WLR_DRM_DEVICES=/dev/dri/card1 # 强制使用独显（删除此行，允许自动识别）
```

### 2. 调整 NVIDIA 相关环境变量（仅保留必要优化，不强制启用）

```diff
# NVIDIA显卡优化
env = __GLX_VENDOR_LIBRARY_NAME,nvidia  # 解决OpenGL渲染异常（保留，避免独显应用冲突）
env = WLR_NO_HARDWARE_CURSORS,1  # 禁用NVIDIA硬件光标加速（保留，避免光标闪烁）

- # NVIDIA独显
- env = GBM_BACKEND,nvidia-drm  # 强制GBM使用NVIDIA（删除，允许自动选择核显GBM）
- env = LIBVA_DRIVER_NAME,nvidia  # 强制VA-API用NVIDIA（删除，核显用intel驱动）
- env = NVD_BACKEND,direct # 提升渲染效率（仅NVIDIA独显有效，混合模式下删除）
- exec-once = nvidia-settings --assign GPULogoBrightness=0  # 独显logo亮度（混合模式无需）

# NVIDIA多线程渲染优化（仅独显应用生效，保留不影响核显）
env = __GL_PERSISTENT_BUFFERS=1
env = __GL_THREADED_OPTIMIZATIONS=1

# NVIDIA游戏性能优化（仅独显应用生效，保留）
env = __GL_MaxFramesAllowed=1
env = __GL_SYNC_TO_VBLANK=0
```

### 3. 补充核显优化配置（可选）

为 Intel 核显添加硬件加速支持（确保 `mesa`、`intel-media-driver` 已安装）：  

```ini
# Intel核显VA-API加速（视频解码）
env = LIBVA_DRIVER_NAME,iHD  # 对应intel-media-driver（若用i965驱动则设为i965）
env = VDPAU_DRIVER,va_gl     # VDPAU转VA-API兼容层
```

## 四、实现自动/手动切换

混合模式下，系统默认使用 Intel 核显，如需调用 NVIDIA 独显运行特定应用，可通过以下方式：

### 1. 临时调用独显运行应用

在终端中用 `prime-run`（envycontrol 会自动配置）前缀启动应用，例如：  

```bash
prime-run steam          # 用独显运行Steam游戏
prime-run blender        # 用独显运行Blender渲染
prime-run glxgears       # 测试独显性能
```

### 2. 自动识别高性能需求（可选）

部分应用（如游戏、视频渲染工具）可通过配置文件默认使用独显，例如为 Steam 添加启动参数：  

- 打开 Steam → 游戏属性 → 启动选项，填入 `prime-run %command%`  

## 五、验证配置是否生效

1. **检查默认显卡（核显）**  
   打开终端运行：  

   ```bash
   glxinfo | grep "OpenGL renderer"
   ```  

   若输出包含 `Intel`（如 `Intel(R) UHD Graphics`），说明默认使用核显。

2. **检查独显是否可用**  
   运行：  

   ```bash
   prime-run glxinfo | grep "OpenGL renderer"
   ```  

   若输出包含 `NVIDIA`（如 `NVIDIA GeForce GTX 1650`），说明独显可正常调用。

3. **测试功耗与性能**  
   - 日常浏览网页、办公时，用 `nvidia-smi` 查看 NVIDIA 显卡功耗（应接近0W，处于休眠）。  
   - 运行 `prime-run glxgears` 时，`nvidia-smi` 应显示显卡活跃（功耗上升）。

## 六、注意事项

1. **驱动兼容性**：确保 NVIDIA 驱动版本 ≥ 510（推荐 535+），Wayland 混合模式支持更稳定。  
2. **休眠问题**：部分设备在混合模式下休眠可能异常，可尝试更新 BIOS 或 NVIDIA 驱动。  
3. **Hyprland 版本**：使用最新版 Hyprland（≥ 0.300），对多显卡支持更好。  

通过以上配置，系统会默认使用 Intel 核显（低功耗），并在运行 `prime-run` 前缀的应用时自动切换到 NVIDIA 独显，实现性能与功耗的平衡。
